# 数据库初始化说明

## 概述

本项目使用自动化的数据库初始化服务，在应用启动时自动创建必要的基础数据和测试数据。

## 初始化流程

应用启动时会执行以下初始化步骤：

```
应用启动
    ↓
Program.cs: InitDbContext()
    ↓
1. EnsureCreated() - 创建数据库架构
    ↓
2. DataInitializationService.InitializeDataAsync()
    ├─→ InitializeTradingPairsAsync()      # 交易对初始化
    ├─→ InitializeSystemUsersAsync()       # 系统用户初始化
    ├─→ InitializeSystemAssetsAsync()      # 系统资产初始化
    ├─→ InitializeTestUsersAsync()         # 测试用户初始化
    └─→ InitializeTestUserAssetsAsync()    # 测试用户资产初始化
```

## 初始化数据详情

### 1. 交易对（Trading Pairs）

| Symbol | BaseAsset | QuoteAsset | MinQuantity | MaxQuantity | PricePrecision | QuantityPrecision |
|--------|-----------|------------|-------------|-------------|----------------|-------------------|
| BTCUSDT | BTC | USDT | 0.00001 | 1000 | 2 | 5 |
| ETHUSDT | ETH | USDT | 0.001 | 10000 | 2 | 3 |
| SOLUSDT | SOL | USDT | 0.01 | 100000 | 3 | 2 |

**特点**：
- 所有交易对默认激活（IsActive = true）
- 支持限价单和市价单交易

### 2. 系统用户（System Users）

#### 2.1 系统做市商（SystemMarketMaker）

```
用户名: SystemMarketMaker
类型: MarketMaker
描述: 系统做市商账号
自动交易: 启用
最大风险比: 10%
每日交易限额: 1,000,000 USDT
```

**初始资产**：
- USDT: 1,000,000
- BTC: 100
- ETH: 5,000
- SOL: 50,000

**用途**：
- 自动做市，提供流动性
- 维持订单簿深度
- 缩小买卖价差

#### 2.2 系统管理员（SystemAdmin）

```
用户名: SystemAdmin
类型: Admin
描述: 系统管理员账号
自动交易: 禁用
最大风险比: 5%
每日交易限额: 500,000 USDT
```

**用途**：
- 系统管理和监控
- 手动干预市场
- 紧急操作处理

### 3. 测试用户（Test Users）

#### 3.1 测试用户 1（test_user_1）

```
用户名: test_user_1
类型: Regular
描述: 测试用户1
自动交易: 禁用
最大风险比: 30%
每日交易限额: 10,000 USDT
```

**初始资产**：
- USDT: 10,000
- BTC: 1
- ETH: 10
- SOL: 100

#### 3.2 测试用户 2（test_user_2）

```
用户名: test_user_2
类型: Regular
描述: 测试用户2
自动交易: 禁用
最大风险比: 30%
每日交易限额: 10,000 USDT
```

**初始资产**：
- USDT: 10,000
- BTC: 1
- ETH: 10
- SOL: 100

#### 3.3 测试用户 3（test_user_3）

```
用户名: test_user_3
类型: Regular
描述: 测试用户3
自动交易: 禁用
最大风险比: 30%
每日交易限额: 10,000 USDT
```

**初始资产**：
- USDT: 10,000
- BTC: 1
- ETH: 10
- SOL: 100

## 配置说明

### appsettings.json 配置

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "server=localhost;database=cryptospot;user=root;password=your_password"
  },
  "MarketMakers": {
    "UserIds": [1]  // 系统做市商用户ID（通常是第一个创建的用户）
  }
}
```

### 做市商配置说明

- `MarketMakers.UserIds`：配置为做市商的用户ID数组
- 支持多个做市商账号
- 做市商之间的成交不会推送到市场
- 可以在配置文件中动态添加或移除

## 使用场景

### 场景 1：本地开发测试

1. **启动应用**
   ```bash
   cd src/CryptoSpot.API
   dotnet run
   ```

2. **查看初始化日志**
   ```
   ✅ Database schema created/verified successfully
   📊 Current user count: 5
   创建交易对: BTCUSDT
   创建交易对: ETHUSDT
   创建交易对: SOLUSDT
   创建系统用户: SystemMarketMaker
   创建系统用户: SystemAdmin
   创建做市商 1 系统资产: USDT - 1000000
   创建测试用户: test_user_1
   创建测试用户: test_user_2
   创建测试用户: test_user_3
   创建测试用户 test_user_1 资产: USDT - 10000
   ✅ Data initialization completed
   ```

3. **使用测试账号登录**
   - 用户名：test_user_1 / test_user_2 / test_user_3
   - 可以立即进行交易测试

### 场景 2：生产环境部署

1. **首次部署**
   - 应用会自动创建数据库和初始数据
   - 系统做市商自动开始做市

2. **后续启动**
   - 检测到数据已存在，跳过初始化
   - 直接启动交易服务

3. **清空数据库重新初始化**
   ```sql
   DROP DATABASE cryptospot;
   CREATE DATABASE cryptospot;
   ```
   然后重启应用即可

## 自定义初始化

### 添加更多交易对

编辑 `DataInitializationService.cs` 中的 `InitializeTradingPairsAsync` 方法：

```csharp
var tradingPairs = new[]
{
    // 现有交易对
    new TradingPair { Symbol = "BTCUSDT", ... },
    
    // 添加新交易对
    new TradingPair
    {
        Symbol = "DOGEUSDT",
        BaseAsset = "DOGE",
        QuoteAsset = "USDT",
        MinQuantity = 1m,
        MaxQuantity = 1000000m,
        PricePrecision = 6,
        QuantityPrecision = 0,
        IsActive = true,
        LastUpdated = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
    }
};
```

### 调整测试用户资产

编辑 `InitializeTestUserAssetsAsync` 方法中的资产配置：

```csharp
var testAssets = new[]
{
    new Asset { UserId = user.Id, Symbol = "USDT", Available = 50000m, ... }, // 增加到 50000
    new Asset { UserId = user.Id, Symbol = "BTC", Available = 5m, ... },      // 增加到 5
    // ... 其他资产
};
```

### 添加更多测试用户

编辑 `InitializeTestUsersAsync` 方法：

```csharp
var testUsers = new[]
{
    // 现有用户
    new User { Username = "test_user_1", ... },
    new User { Username = "test_user_2", ... },
    new User { Username = "test_user_3", ... },
    
    // 添加新用户
    new User
    {
        Username = "test_user_4",
        Type = UserType.Regular,
        Description = "测试用户4",
        IsActive = true,
        IsAutoTradingEnabled = false,
        MaxRiskRatio = 0.3m,
        DailyTradingLimit = 10000m,
        DailyTradedAmount = 0m
    }
};
```

## 数据库架构

### 核心表结构

```sql
-- 用户表
Users (Id, Username, Type, Description, IsActive, ...)

-- 交易对表
TradingPairs (Id, Symbol, BaseAsset, QuoteAsset, ...)

-- 资产表
Assets (Id, UserId, Symbol, Available, Frozen, ...)

-- 订单表
Orders (Id, OrderId, UserId, TradingPairId, Side, Type, Price, Quantity, Status, ...)

-- 成交表
Trades (Id, TradeId, BuyOrderId, SellOrderId, BuyerId, SellerId, Price, Quantity, ...)

-- K线数据表
KLineData (Id, Symbol, TimeFrame, OpenTime, Open, High, Low, Close, Volume, ...)
```

## 常见问题

### Q1: 首次启动时看不到初始化日志？

**A**: 检查以下几点：
1. 数据库连接字符串是否正确
2. 数据库服务是否启动
3. 用户权限是否足够（需要CREATE DATABASE权限）
4. 查看应用日志输出

### Q2: 如何重置数据库到初始状态？

**A**: 
```sql
-- 方法1：删除并重建数据库
DROP DATABASE cryptospot;
CREATE DATABASE cryptospot;

-- 方法2：清空所有表数据
TRUNCATE TABLE Trades;
TRUNCATE TABLE Orders;
TRUNCATE TABLE Assets;
TRUNCATE TABLE Users;
TRUNCATE TABLE TradingPairs;
TRUNCATE TABLE KLineData;
```
然后重启应用。

### Q3: 测试用户的初始密码是什么？

**A**: 当前版本的测试用户没有设置密码字段（使用 JWT Token 认证）。如果需要密码认证，需要：
1. 在 User 实体中添加 PasswordHash 字段
2. 在初始化时设置默认密码
3. 实现注册/登录接口

建议密码：
```csharp
PasswordHash = BCrypt.Net.BCrypt.HashPassword("Test123!")
```

### Q4: 如何临时禁用测试用户初始化？

**A**: 注释掉 `InitializeDataAsync` 方法中的相关调用：

```csharp
public async Task InitializeDataAsync()
{
    await InitializeTradingPairsAsync();
    await InitializeSystemUsersAsync();
    await InitializeSystemAssetsAsync();
    // await InitializeTestUsersAsync();         // 临时禁用
    // await InitializeTestUserAssetsAsync();    // 临时禁用
}
```

### Q5: 初始化失败会影响应用启动吗？

**A**: 不会。初始化失败只会记录错误日志，应用会继续启动。但建议：
1. 查看错误日志，解决初始化问题
2. 手动执行 SQL 脚本初始化数据
3. 确保数据库连接和权限正常

## 日志监控

### 成功初始化日志

```
✅ Database schema created/verified successfully
📊 Current user count: 5
创建交易对: BTCUSDT
创建交易对: ETHUSDT
创建交易对: SOLUSDT
创建系统用户: SystemMarketMaker
创建系统用户: SystemAdmin
创建做市商 1 系统资产: USDT - 1000000
创建做市商 1 系统资产: BTC - 100
创建做市商 1 系统资产: ETH - 5000
创建做市商 1 系统资产: SOL - 50000
创建测试用户: test_user_1
创建测试用户: test_user_2
创建测试用户: test_user_3
创建测试用户 test_user_1 资产: USDT - 10000
创建测试用户 test_user_1 资产: BTC - 1
✅ Data initialization completed
```

### 数据已存在日志

```
✅ Database schema created/verified successfully
📊 Current user count: 5
✅ Data already initialized
```

### 初始化失败日志

```
❌ Database setup failed: Unable to connect to database
数据初始化失败: Connection timeout
```

## 手动 SQL 脚本（备用方案）

如果自动初始化失败，可以使用以下 SQL 脚本手动初始化：

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS cryptospot;
USE cryptospot;

-- 插入交易对
INSERT INTO TradingPairs (Symbol, BaseAsset, QuoteAsset, MinQuantity, MaxQuantity, PricePrecision, QuantityPrecision, IsActive, LastUpdated)
VALUES 
('BTCUSDT', 'BTC', 'USDT', 0.00001, 1000, 2, 5, 1, UNIX_TIMESTAMP() * 1000),
('ETHUSDT', 'ETH', 'USDT', 0.001, 10000, 2, 3, 1, UNIX_TIMESTAMP() * 1000),
('SOLUSDT', 'SOL', 'USDT', 0.01, 100000, 3, 2, 1, UNIX_TIMESTAMP() * 1000);

-- 插入系统用户
INSERT INTO Users (Username, Type, Description, IsActive, IsAutoTradingEnabled, MaxRiskRatio, DailyTradingLimit, DailyTradedAmount)
VALUES 
('SystemMarketMaker', 1, '系统做市商账号', 1, 1, 0.1, 1000000, 0),
('SystemAdmin', 2, '系统管理员账号', 1, 0, 0.05, 500000, 0);

-- 插入测试用户
INSERT INTO Users (Username, Type, Description, IsActive, IsAutoTradingEnabled, MaxRiskRatio, DailyTradingLimit, DailyTradedAmount)
VALUES 
('test_user_1', 0, '测试用户1', 1, 0, 0.3, 10000, 0),
('test_user_2', 0, '测试用户2', 1, 0, 0.3, 10000, 0),
('test_user_3', 0, '测试用户3', 1, 0, 0.3, 10000, 0);

-- 插入系统资产（假设做市商ID为1）
INSERT INTO Assets (UserId, Symbol, Available, Frozen, MinReserve, TargetBalance, AutoRefillEnabled)
VALUES 
(1, 'USDT', 1000000, 0, 100000, 1000000, 1),
(1, 'BTC', 100, 0, 10, 100, 1),
(1, 'ETH', 5000, 0, 500, 5000, 1),
(1, 'SOL', 50000, 0, 5000, 50000, 1);

-- 插入测试用户资产（假设test_user_1的ID为3）
INSERT INTO Assets (UserId, Symbol, Available, Frozen, MinReserve, TargetBalance, AutoRefillEnabled)
VALUES 
(3, 'USDT', 10000, 0, 0, 10000, 0),
(3, 'BTC', 1, 0, 0, 1, 0),
(3, 'ETH', 10, 0, 0, 10, 0),
(3, 'SOL', 100, 0, 0, 100, 0);

-- 对其他测试用户重复类似操作
```

## 相关文件

- `DataInitializationService.cs` - 初始化服务实现
- `ServiceCollectionExtensions.cs` - 服务注册和初始化调用
- `Program.cs` - 应用启动配置
- `appsettings.json` - 数据库连接和做市商配置

## 最佳实践

1. **开发环境**：使用自动初始化，快速搭建测试环境
2. **生产环境**：首次部署后，建议导出数据库快照
3. **测试环境**：定期重置数据库到初始状态
4. **持续集成**：在 CI/CD 中自动执行初始化测试
5. **备份策略**：定期备份生产数据库
