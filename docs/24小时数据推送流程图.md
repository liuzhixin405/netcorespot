# 24小时数据推送流程图

## 📊 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      外部数据源                                  │
│                  OKX WebSocket API                               │
│                                                                   │
│  提供：Ticker（包含24h价格、涨跌幅、交易量、最高价、最低价）    │
└────────────────────────────┬────────────────────────────────────┘
                             │ WebSocket 推送（约100ms-1s）
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│              OkxMarketDataStreamProvider                         │
│                    (实现 IMarketDataStreamProvider)              │
│                                                                   │
│  功能：                                                          │
│  - 连接 OKX WebSocket                                           │
│  - 订阅 Ticker 频道                                              │
│  - 解析 JSON 数据                                                │
│  - 触发 OnTicker 事件                                            │
└────────────────────────────┬────────────────────────────────────┘
                             │ OnTicker 事件
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│         MarketDataStreamRelayService (后台服务)                  │
│                                                                   │
│  功能：                                                          │
│  ┌─────────────────────────────────────────────────────┐       │
│  │ 1. 接收 MarketTicker 数据                            │       │
│  │    - symbol: "BTCUSDT"                              │       │
│  │    - price: 50000                                   │       │
│  │    - change24h: 0.0523 (5.23%)                      │       │
│  │    - volume24h: 1234567.89                          │       │
│  │    - high24h: 51000                                 │       │
│  │    - low24h: 48500                                  │       │
│  └─────────────────────────────────────────────────────┘       │
│                          │                                       │
│  ┌─────────────────────────────────────────────────────┐       │
│  │ 2. 数据去重 & 限流                                    │       │
│  │    - 哈希比对：避免重复推送相同数据                  │       │
│  │    - 限流：最小间隔 1000ms                           │       │
│  └─────────────────────────────────────────────────────┘       │
│                          │                                       │
│           ┌──────────────┴──────────────┐                       │
│           ↓                             ↓                       │
│  ┌──────────────────┐         ┌──────────────────┐            │
│  │ 3a. 实时推送      │         │ 3b. 异步持久化    │            │
│  │ SignalR          │         │ 到数据库          │            │
│  └──────────────────┘         └──────────────────┘            │
└───────────┬───────────────────────────┬────────────────────────┘
            │                           │
            ↓                           ↓
┌───────────────────────┐    ┌─────────────────────────┐
│ SignalRDataPushService│    │   PriceDataService      │
│                       │    │                         │
│ PushPriceDataAsync() │    │ UpdateTradingPairPrice()│
└───────────┬───────────┘    └────────┬────────────────┘
            │                         │
            │                         ↓
            │              ┌──────────────────────┐
            │              │   TradingPairs 表     │
            │              │                       │
            │              │ UPDATE TradingPairs  │
            │              │ SET Price = ...      │
            │              │     Change24h = ...  │
            │              │     Volume24h = ...  │
            │              └──────────────────────┘
            ↓
┌─────────────────────────────────────────────────────────────────┐
│                     SignalR Hub                                  │
│                                                                   │
│  频道：price_BTCUSDT                                             │
│  事件：PriceUpdate                                               │
│                                                                   │
│  推送数据：                                                       │
│  {                                                                │
│    "symbol": "BTCUSDT",                                          │
│    "price": 50000.00,                                            │
│    "change24h": 0.0523,                                          │
│    "volume24h": 1234567.89,                                      │
│    "high24h": 51000.00,                                          │
│    "low24h": 48500.00,                                           │
│    "timestamp": 1729584000000                                    │
│  }                                                                │
└────────────────────────────┬────────────────────────────────────┘
                             │ WebSocket
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│                   前端 (React)                                   │
│                                                                   │
│  ┌────────────────────────────────────────────────────┐         │
│  │  signalRClient.ts                                  │         │
│  │                                                     │         │
│  │  - 建立 WebSocket 连接                              │         │
│  │  - 加入组：JoinGroup('price_BTCUSDT')              │         │
│  │  - 监听：connection.on('PriceUpdate', handler)     │         │
│  └───────────────────────┬────────────────────────────┘         │
│                          │                                       │
│  ┌────────────────────────────────────────────────────┐         │
│  │  useMergedTickerData.ts (React Hook)               │         │
│  │                                                     │         │
│  │  功能：                                             │         │
│  │  1. 从 localStorage 恢复缓存                        │         │
│  │  2. 订阅 PriceUpdate 事件                           │         │
│  │  3. 合并多个数据源                                  │         │
│  │  4. 更新 React State                                │         │
│  │  5. 保存到 localStorage                             │         │
│  └───────────────────────┬────────────────────────────┘         │
│                          │                                       │
│                          ↓                                       │
│  ┌────────────────────────────────────────────────────┐         │
│  │  UI 组件 (TradingPairInfo, TradingView, etc.)      │         │
│  │                                                     │         │
│  │  展示：                                             │         │
│  │  - 当前价格: $50,000.00                             │         │
│  │  - 24h 涨跌: +5.23% ↑                              │         │
│  │  - 24h 最高: $51,000.00                            │         │
│  │  - 24h 最低: $48,500.00                            │         │
│  │  - 24h 量: 1,234,567.89 BTC                        │         │
│  └────────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 时序图

```
时间  OKX API    Provider    Relay         SignalR      Database    Frontend
│                                                                    
├─────────────────────────────────────────────────────────────────
│     
0ms   Ticker1 ──→
│                OnTicker ──→
│                            去重/限流 ──→
│                                        Push ──→
│                                                Async──→
│                                                         Update ──→
│                                                         
100ms Ticker2 ──→                                        (保存中)
│                OnTicker ──→                             
│                            [去重-跳过]                   (完成)
│                                                         
1000ms Ticker3 ──→                                       
│                 OnTicker ──→
│                            去重/限流 ──→
│                                        Push ──→
│                                                Async──→
│                                                         Update ──→
│                                                                  
1100ms                                                             Render
│                                                                  UI更新
```

## 📝 关键代码位置

### 后端代码

| 文件 | 路径 | 功能 |
|------|------|------|
| MarketTicker | `Domain/Entities/MarketData.cs` | 数据结构定义 |
| IMarketDataStreamProvider | `Application/Abstractions/Services/MarketData/` | 提供者接口 |
| OkxMarketDataStreamProvider | `Infrastructure/ExternalServices/` | OKX 实现 |
| MarketDataStreamRelayService | `Infrastructure/BgService/` | 数据中继服务 |
| SignalRDataPushService | `Infrastructure/BgService/` | SignalR 推送 |
| PriceDataService | `Infrastructure/Services/` | 数据持久化 |
| TradingPair | `Domain/Entities/` | 数据库实体 |

### 前端代码

| 文件 | 路径 | 功能 |
|------|------|------|
| signalRClient.ts | `frontend/src/services/` | WebSocket 客户端 |
| useMergedTickerData.ts | `frontend/src/hooks/` | React Hook |
| types/index.ts | `frontend/src/types/` | TypeScript 类型 |
| TradingView.tsx | `frontend/src/pages/` | 交易页面 |

## 🎯 数据格式对比

### 1. OKX 原始数据（WebSocket）

```json
{
  "arg": {
    "channel": "tickers",
    "instId": "BTC-USDT"
  },
  "data": [{
    "instId": "BTC-USDT",
    "last": "50000",
    "lastSz": "0.1",
    "askPx": "50001",
    "bidPx": "49999",
    "open24h": "47500",
    "high24h": "51000",
    "low24h": "48500",
    "vol24h": "1234567.89",
    "volCcy24h": "6172839450",
    "ts": "1729584000000"
  }]
}
```

### 2. 后端 MarketTicker（领域对象）

```csharp
public record MarketTicker
{
    Symbol = "BTCUSDT",
    Last = 50000m,
    ChangePercent = 0.0526m,      // 计算：(50000-47500)/47500
    Volume24h = 1234567.89m,
    High24h = 51000m,
    Low24h = 48500m,
    Ts = 1729584000000L
}
```

### 3. SignalR 推送数据

```json
{
  "symbol": "BTCUSDT",
  "price": 50000.00,
  "change24h": 0.0526,
  "volume24h": 1234567.89,
  "high24h": 51000.00,
  "low24h": 48500.00,
  "timestamp": 1729584000000
}
```

### 4. 前端 MergedTickerData

```typescript
{
  symbol: "BTCUSDT",
  lastPrice: 50000.00,
  change24h: 0.0526,           // 小数形式
  volume24h: 1234567.89,
  high24h: 51000.00,
  low24h: 48500.00,
  timestamp: 1729584000000,
  _rawPrice: { /* 原始帧 */ },
  _rawTicker: { /* 原始帧 */ }
}
```

### 5. UI 展示格式

```
BTCUSDT
$50,000.00
+5.26% ↑

24h 最高: $51,000.00
24h 最低: $48,500.00
24h 量: 1,234,567.89 BTC
```

## 🚀 性能特点

### 去重机制
```
数据哈希 = "50000|0.0526|1234567.89|51000|48500"
如果哈希相同 → 跳过推送 ✅
```

### 限流机制
```
最小推送间隔: 1000ms
当前时间 - 上次推送时间 < 1000ms → 跳过 ✅
```

### 异步持久化
```
实时推送 → 立即完成（不等待数据库）
数据库更新 → Task.Run 异步执行 ✅
```

### 前端缓存
```
localStorage.setItem('merged_ticker_cache_BTCUSDT', data)
页面刷新 → 立即恢复缓存数据 ✅
```

## 📊 数据更新频率

| 层级 | 频率 | 说明 |
|------|------|------|
| OKX API | 100ms - 1s | 外部数据源推送频率 |
| Provider | 实时 | 立即触发 OnTicker 事件 |
| Relay | 最快 1s/次 | 限流保护（可配置） |
| SignalR | 实时 | WebSocket 推送 |
| Database | 异步 | 不阻塞实时推送 |
| Frontend | 实时 | 响应 WebSocket 消息 |

## 🔧 配置项

### 推送间隔（后端）

```csharp
// MarketDataStreamRelayService.cs
const int TickerMinPushIntervalMs = 1000;  // 1秒

// 调整为更快更新
const int TickerMinPushIntervalMs = 500;   // 0.5秒

// 调整为减少负载
const int TickerMinPushIntervalMs = 2000;  // 2秒
```

### 订阅交易对

```csharp
// MarketDataStreamRelayService.cs
private readonly string[] _symbols = new[] { 
    "BTCUSDT", 
    "ETHUSDT", 
    "SOLUSDT" 
};
```

### 数据来源切换

```csharp
// Program.cs
// 使用 OKX
builder.Services.AddSingleton<IMarketDataStreamProvider, OkxMarketDataStreamProvider>();

// 或使用 Binance
builder.Services.AddSingleton<IMarketDataStreamProvider, BinanceMarketDataStreamProvider>();
```

## 🐛 调试技巧

### 查看实时日志

```bash
# 查看 Ticker 推送日志
tail -f logs/app.log | grep "Ticker Relay"

# 查看数据库更新日志
tail -f logs/app.log | grep "价格持久化"
```

### 前端调试

```typescript
// 查看原始数据帧
const { data } = useMergedTickerData('BTCUSDT');
console.log('Raw Price:', data?._rawPrice);
console.log('Raw Ticker:', data?._rawTicker);

// 检查缓存
const cached = localStorage.getItem('merged_ticker_cache_BTCUSDT');
console.log('Cached:', JSON.parse(cached || '{}'));

// 检查连接状态
console.log('SignalR Connected:', signalRClient.isConnected());
```

### 数据库检查

```sql
-- 查看最新价格数据
SELECT 
    Symbol, 
    Price, 
    Change24h, 
    Volume24h, 
    High24h, 
    Low24h,
    FROM_UNIXTIME(LastUpdated/1000) AS LastUpdate
FROM TradingPairs 
WHERE Symbol = 'BTCUSDT';

-- 查看更新频率
SELECT 
    Symbol,
    COUNT(*) as UpdateCount,
    MAX(FROM_UNIXTIME(LastUpdated/1000)) as LatestUpdate
FROM TradingPairs 
GROUP BY Symbol;
```

## ✅ 验证清单

- [ ] OKX WebSocket 连接成功
- [ ] Provider 收到 Ticker 事件
- [ ] Relay Service 正常运行
- [ ] SignalR 推送到前端
- [ ] 数据库正确更新
- [ ] 前端显示实时数据
- [ ] 缓存机制工作正常
- [ ] 去重机制生效
- [ ] 限流机制生效
- [ ] 日志记录完整

## 📖 相关文档

- [24小时数据推送流程详解.md](./24小时数据推送流程详解.md) - 完整技术文档
- [成交推送逻辑详解.md](./成交推送逻辑详解.md) - 成交推送说明
- [订单撮合逻辑说明.md](./订单撮合逻辑说明.md) - 撮合逻辑说明
