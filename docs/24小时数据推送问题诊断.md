# 24小时数据推送问题诊断脚本

## 问题描述
24小时数据（价格变化、交易量、最高价、最低价）推送无更新

## 已修复的问题

### 1. OKX Ticker 数据字段错误 ✅

**问题**：
```csharp
// 错误：使用了 volCcy24h（计价货币交易量，如 USDT 的量）
var volQuote = GetDecimal(d, "volCcy24h");

// 正确：应该使用 vol24h（基础货币交易量，如 BTC 的量）
var volume24h = GetDecimal(d, "vol24h");
```

**修复位置**：
- 文件：`OkxMarketDataStreamProvider.cs`
- 行号：约 335 行
- 修改：将 `volCcy24h` 改为 `vol24h`

### 2. 日志级别不足 ✅

**问题**：
```csharp
// LogDebug 在生产环境默认不显示
_logger.LogDebug("Ticker Relay 推送完成 ...");
```

**修复**：
```csharp
// 改为 LogInformation，确保能看到推送日志
_logger.LogInformation("✅ Ticker Relay 推送完成 ...");
```

**修复位置**：
- 文件：`MarketDataStreamRelayService.cs`
- 行号：约 183 行

### 3. 增强日志输出 ✅

添加了详细的调试信息：
```csharp
_logger.LogDebug("📊 OKX Ticker: {Symbol} Price={Last} Change={Change:P2} Vol={Vol}", 
    symbol, last, changePercent, volume24h);
```

## 诊断步骤

### 步骤 1: 检查后台服务是否运行

```bash
# 查看应用日志，确认服务启动
grep "MarketDataStream" logs/app.log
grep "OKX" logs/app.log
grep "启动流式行情提供者" logs/app.log
```

**期望输出**：
```
已启动流式行情提供者: OKX
OKX Public WS 已连接: wss://ws.okx.com:8443/ws/v5/public
OKX Business WS 已连接: wss://ws.okx.com:8443/ws/v5/business
```

### 步骤 2: 检查 Ticker 订阅

```bash
# 查看订阅日志
grep "tickers" logs/app.log
grep "订阅" logs/app.log
```

**期望输出**：
```
OKX 订阅: {"op":"subscribe","args":[{"channel":"tickers","instId":"BTC-USDT"}]}
```

### 步骤 3: 检查数据接收

```bash
# 查看 OKX 推送的原始数据
grep "OKX Ticker:" logs/app.log | tail -10

# 查看中继推送日志
grep "Ticker Relay 推送完成" logs/app.log | tail -10
```

**期望输出**：
```
📊 OKX Ticker: BTCUSDT Price=50000 Change=5.26% Vol=1234567.89
✅ Ticker Relay 推送完成 BTCUSDT price=50000 change=5.26% vol=1234567.89 high=51000 low=48500
```

### 步骤 4: 检查数据库更新

```sql
-- 查看最新的价格数据
SELECT 
    Symbol, 
    Price, 
    Change24h, 
    Volume24h, 
    High24h, 
    Low24h,
    FROM_UNIXTIME(LastUpdated/1000) AS LastUpdate
FROM TradingPairs 
WHERE Symbol IN ('BTCUSDT', 'ETHUSDT', 'SOLUSDT')
ORDER BY LastUpdated DESC;
```

**期望结果**：
- `LastUpdate` 应该是最近的时间（1-2秒内）
- `Price`、`Change24h`、`Volume24h` 等应该有值

### 步骤 5: 检查 SignalR 推送

```bash
# 查看 SignalR 推送日志
grep "PriceUpdate" logs/app.log | tail -10
grep "SignalR" logs/app.log | grep "price" | tail -10
```

**期望输出**：
```
Pushed price data for BTCUSDT
```

### 步骤 6: 前端检查

打开浏览器开发者工具（F12）：

#### 6.1 检查 WebSocket 连接

```javascript
// 在控制台执行
console.log('SignalR Connected:', signalRClient?.isConnected());
```

**期望输出**：`true`

#### 6.2 检查订阅状态

```javascript
// 查看当前订阅的组
// 应该包含 price_BTCUSDT 等
```

#### 6.3 监听消息

```javascript
// 在控制台手动监听
signalRClient.connection.on('PriceUpdate', (data) => {
  console.log('Received PriceUpdate:', data);
});
```

**期望输出**：
```json
{
  "symbol": "BTCUSDT",
  "price": 50000.00,
  "change24h": 0.0526,
  "volume24h": 1234567.89,
  "high24h": 51000.00,
  "low24h": 48500.00,
  "timestamp": 1729584000000
}
```

#### 6.4 检查 localStorage 缓存

```javascript
// 查看缓存数据
const cached = localStorage.getItem('merged_ticker_cache_BTCUSDT');
console.log('Cached:', JSON.parse(cached || '{}'));
```

## 常见问题排查

### 问题 1: OKX WebSocket 连接失败

**症状**：
```
OKX Public WS 连接失败
Unable to connect to the remote server
```

**解决方案**：
1. 检查网络连接
2. 检查防火墙设置
3. 尝试使用代理

```json
// appsettings.json
{
  "Okx": {
    "PublicWs": "wss://ws.okx.com:8443/ws/v5/public",
    "BusinessWs": "wss://ws.okx.com:8443/ws/v5/business",
    "Proxy": "http://your-proxy:port"  // 如果需要代理
  }
}
```

### 问题 2: 没有收到 Ticker 数据

**症状**：
```
已启动流式行情提供者: OKX
但是没有 "OKX Ticker:" 日志
```

**可能原因**：
1. 订阅失败
2. OKX 返回错误
3. 数据解析失败

**排查**：
```bash
# 查看完整的 WebSocket 消息
grep "OKX PUB:" logs/app.log | grep "tickers"

# 查看错误消息
grep "OKX 订阅错误" logs/app.log
grep "HandleMessage 异常" logs/app.log
```

### 问题 3: 数据接收但不推送

**症状**：
```
📊 OKX Ticker: BTCUSDT ...
但是没有 "Ticker Relay 推送完成" 日志
```

**可能原因**：
1. 去重机制拦截（数据未变化）
2. 限流机制拦截（推送太频繁）
3. 推送服务异常

**排查**：
```bash
# 查看去重日志（如果有的话）
grep "去重" logs/app.log

# 查看 RelayTicker 异常
grep "RelayTicker 失败" logs/app.log
```

**临时禁用限流测试**：
```csharp
// MarketDataStreamRelayService.cs
// 临时改为 0，测试是否是限流问题
const int TickerMinPushIntervalMs = 0;  // 原来是 1000
```

### 问题 4: 推送到 SignalR 但前端收不到

**症状**：
```
✅ Ticker Relay 推送完成 BTCUSDT ...
但前端控制台没有 PriceUpdate 消息
```

**可能原因**：
1. 前端未订阅正确的组
2. SignalR 连接断开
3. 频道名称不匹配

**排查**：
```typescript
// 前端检查订阅
console.log('Subscribing to:', `price_${symbol}`);

// 手动加入组测试
await connection.invoke('JoinGroup', 'price_BTCUSDT');

// 监听所有消息
connection.on('PriceUpdate', (data) => {
  console.log('✅ Received:', data);
});
```

### 问题 5: 数据更新但显示不正确

**症状**：
```
收到 PriceUpdate 消息
但 UI 显示的数据不对或不更新
```

**可能原因**：
1. React State 未更新
2. 缓存数据覆盖新数据
3. 数据格式转换错误

**排查**：
```typescript
// 检查 Hook 状态
const { data, loading, error } = useMergedTickerData('BTCUSDT');
console.log('Hook State:', { data, loading, error });

// 清除缓存重试
localStorage.removeItem('merged_ticker_cache_BTCUSDT');
window.location.reload();

// 检查数据格式
console.log('change24h type:', typeof data?.change24h);
console.log('change24h value:', data?.change24h);
```

## 快速修复指南

### 修复 1: 重启应用

```bash
# 停止应用
# Ctrl+C

# 重新构建并运行
cd src/CryptoSpot.API
dotnet build
dotnet run
```

### 修复 2: 清除前端缓存

```javascript
// 在浏览器控制台执行
localStorage.clear();
location.reload();
```

### 修复 3: 手动触发订阅

```javascript
// 在浏览器控制台执行
await signalRClient.reconnect();
```

### 修复 4: 检查配置文件

```json
// appsettings.json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "CryptoSpot.Infrastructure.BgService": "Debug",
      "CryptoSpot.Infrastructure.ExternalServices": "Debug"
    }
  },
  "Okx": {
    "PublicWs": "wss://ws.okx.com:8443/ws/v5/public",
    "BusinessWs": "wss://ws.okx.com:8443/ws/v5/business"
  }
}
```

## 验证修复

### 完整验证清单

- [ ] 应用启动日志显示 "已启动流式行情提供者: OKX"
- [ ] OKX WebSocket 连接成功
- [ ] Ticker 订阅成功
- [ ] 收到 OKX Ticker 数据（每1-2秒一次）
- [ ] Ticker Relay 推送日志出现
- [ ] 数据库 TradingPairs 表更新
- [ ] SignalR 推送日志出现
- [ ] 前端 WebSocket 连接状态为 true
- [ ] 前端收到 PriceUpdate 消息
- [ ] UI 显示正确的 24h 数据
- [ ] 数据实时更新（约1秒/次）

### 测试命令

```bash
# 后端日志实时监控
tail -f logs/app.log | grep -E "OKX Ticker|Ticker Relay|PriceUpdate"

# 数据库实时查询（每2秒刷新）
watch -n 2 "mysql -u root -p -e 'SELECT Symbol, Price, Change24h, Volume24h, FROM_UNIXTIME(LastUpdated/1000) FROM cryptospot.TradingPairs;'"
```

### 前端测试代码

```typescript
// 测试工具函数
function test24hData(symbol: string = 'BTCUSDT') {
  const { data, loading, error, isConnected } = useMergedTickerData(symbol);
  
  console.group(`📊 ${symbol} 24h 数据测试`);
  console.log('连接状态:', isConnected ? '✅ 已连接' : '❌ 未连接');
  console.log('加载状态:', loading ? '⏳ 加载中' : '✅ 已加载');
  console.log('错误信息:', error || '无');
  console.log('数据:', {
    价格: data?.lastPrice,
    '24h涨跌': data?.change24h ? `${(data.change24h * 100).toFixed(2)}%` : 'N/A',
    '24h交易量': data?.volume24h,
    '24h最高': data?.high24h,
    '24h最低': data?.low24h,
    更新时间: data?.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A'
  });
  console.groupEnd();
  
  return { data, loading, error, isConnected };
}

// 在组件中使用
useEffect(() => {
  const timer = setInterval(() => {
    test24hData();
  }, 5000); // 每5秒打印一次
  
  return () => clearInterval(timer);
}, []);
```

## 性能监控

### 监控指标

```bash
# 查看推送频率
grep "Ticker Relay 推送完成" logs/app.log | wc -l  # 总推送次数

# 查看去重率
grep "去重" logs/app.log | wc -l  # 被去重的次数

# 查看限流率
# (总接收 - 总推送) / 总接收 * 100%

# 查看延迟
# 对比 OKX Ticker 时间戳和 Relay 推送时间戳
```

### 性能优化建议

如果发现推送太慢或延迟高：

1. **调整限流间隔**：
```csharp
// 减小到 500ms
const int TickerMinPushIntervalMs = 500;
```

2. **禁用去重**（临时测试）：
```csharp
// 注释掉去重逻辑
// if (state.Hash == hash && ...) return;
```

3. **增加日志级别**：
```json
{
  "Logging": {
    "LogLevel": {
      "CryptoSpot.Infrastructure.BgService": "Trace"
    }
  }
}
```

## 联系支持

如果以上步骤都无法解决问题，请收集以下信息：

1. 完整的启动日志（前100行）
2. 最近的错误日志（`grep ERROR logs/app.log`）
3. 数据库 TradingPairs 表的截图
4. 前端控制台的截图
5. Network 标签中 WebSocket 连接的详情

## 相关文档

- [24小时数据推送流程详解.md](./24小时数据推送流程详解.md)
- [24小时数据推送流程图.md](./24小时数据推送流程图.md)
