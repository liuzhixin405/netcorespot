# 24小时数据推送完整流程

## 概述

本文档详细说明 24 小时统计数据（价格变化、交易量、最高价、最低价）的数据来源、处理流程、推送机制和前端展示。

## 数据流向图

```
外部数据源（OKX/Binance）
    ↓
IMarketDataStreamProvider (OkxMarketDataStreamProvider)
    ↓
MarketDataStreamRelayService (后台服务)
    ↓
    ├─→ PriceDataService (数据库持久化)
    │   └─→ TradingPairs 表
    │
    └─→ SignalRDataPushService (实时推送)
        └─→ SignalR Hub → 前端
            ↓
        前端 useMergedTickerData Hook
            ↓
        UI 组件展示
```

## 后端实现

### 1. 数据结构定义

#### 交易对实体（TradingPair）

```csharp
// CryptoSpot.Domain/Entities/TradingPair.cs
public class TradingPair
{
    public int Id { get; set; }
    public string Symbol { get; set; }           // 交易对符号，如 "BTCUSDT"
    public decimal Price { get; set; }           // 当前价格
    public decimal Change24h { get; set; }       // 24小时价格变化（小数，0.05 = 5%）
    public decimal Volume24h { get; set; }       // 24小时交易量
    public decimal High24h { get; set; }         // 24小时最高价
    public decimal Low24h { get; set; }          // 24小时最低价
    public long LastUpdated { get; set; }        // 最后更新时间戳（毫秒）
    // ... 其他字段
}
```

#### DTO 数据传输对象

```csharp
// CryptoSpot.Application/DTOs/Trading/TradingPairDto.cs
public class TradingPairDto
{
    public string Symbol { get; set; }
    public decimal Price { get; set; }
    public decimal Change24h { get; set; }         // 绝对变化值
    public decimal Change24hPercent { get; set; }  // 百分比变化
    public decimal Volume24h { get; set; }
    public decimal High24h { get; set; }
    public decimal Low24h { get; set; }
    public DateTime LastUpdated { get; set; }
}
```

### 2. 数据来源

#### 外部市场数据提供者接口

```csharp
// CryptoSpot.Application/Abstractions/Services/MarketData/IMarketDataStreamProvider.cs
public interface IMarketDataStreamProvider
{
    string ProviderName { get; }
    
    // 订阅 Ticker（包含24小时数据）
    Task SubscribeTickerAsync(string symbol, CancellationToken ct);
    
    // Ticker 事件（包含24h统计）
    event Action<MarketTicker> OnTicker;
}
```

#### MarketTicker 结构

```csharp
// CryptoSpot.Domain/Entities/MarketData.cs
public record MarketTicker
{
    public string Symbol { get; init; }
    public decimal Last { get; init; }          // 最新价
    public decimal ChangePercent { get; init; } // 24h涨跌幅（小数）
    public decimal Volume24h { get; init; }     // 24h交易量
    public decimal High24h { get; init; }       // 24h最高价
    public decimal Low24h { get; init; }        // 24h最低价
    public long Ts { get; init; }               // 时间戳
}
```

#### OKX 数据提供者实现

```csharp
// CryptoSpot.Infrastructure/ExternalServices/OkxMarketDataStreamProvider.cs
public class OkxMarketDataStreamProvider : IMarketDataStreamProvider
{
    public string ProviderName => "OKX";
    
    private void HandleTickerMessage(JsonNode node)
    {
        var data = node["data"]?[0];
        var ticker = new MarketTicker
        {
            Symbol = ConvertToLocalSymbol(data?["instId"]?.GetValue<string>()),
            Last = decimal.Parse(data?["last"]?.GetValue<string>() ?? "0"),
            ChangePercent = decimal.Parse(data?["changeRate"]?.GetValue<string>() ?? "0"),
            Volume24h = decimal.Parse(data?["vol24h"]?.GetValue<string>() ?? "0"),
            High24h = decimal.Parse(data?["high24h"]?.GetValue<string>() ?? "0"),
            Low24h = decimal.Parse(data?["low24h"]?.GetValue<string>() ?? "0"),
            Ts = long.Parse(data?["ts"]?.GetValue<string>() ?? "0")
        };
        
        OnTicker?.Invoke(ticker);
    }
}
```

**数据来源**：
- OKX WebSocket Ticker API
- 实时推送，约 100ms - 1s 更新一次
- 包含完整的 24 小时统计数据

### 3. 数据中继服务（核心处理）

```csharp
// CryptoSpot.Infrastructure/BgService/MarketDataStreamRelayService.cs
public class MarketDataStreamRelayService : BackgroundService
{
    // 处理 Ticker 数据
    private async Task RelayTickerAsync(MarketTicker t, CancellationToken ct)
    {
        // 1. 构造推送数据
        var priceData = new
        {
            symbol = t.Symbol,
            price = t.Last,
            change24h = t.ChangePercent,    // 24h 涨跌幅
            volume24h = t.Volume24h,        // 24h 交易量
            high24h = t.High24h,            // 24h 最高价
            low24h = t.Low24h,              // 24h 最低价
            timestamp = t.Ts
        };

        // 2. 实时推送给前端（SignalR）
        await push.PushPriceDataAsync(t.Symbol, priceData);

        // 3. 异步持久化到数据库
        await priceService.UpdateTradingPairPriceAsync(
            t.Symbol, 
            t.Last, 
            t.ChangePercent, 
            t.Volume24h, 
            t.High24h, 
            t.Low24h
        );
    }
}
```

**关键特性**：
- 去重处理：相同数据不重复推送
- 限流：最小推送间隔 1000ms
- 异步持久化：不阻塞实时推送
- 错误隔离：推送失败不影响持久化

### 4. 数据持久化

```csharp
// CryptoSpot.Infrastructure/Services/PriceDataService.cs
public class PriceDataService : IPriceDataService
{
    public async Task UpdateTradingPairPriceAsync(
        string symbol, 
        decimal price, 
        decimal change24h, 
        decimal volume24h, 
        decimal high24h, 
        decimal low24h)
    {
        await _tradingPairService.UpdatePriceAsync(
            symbol, price, change24h, volume24h, high24h, low24h);
    }
}
```

```sql
-- 数据库更新语句
UPDATE TradingPairs 
SET Price = @price, 
    Change24h = @change24h, 
    Volume24h = @volume24h, 
    High24h = @high24h, 
    Low24h = @low24h, 
    UpdatedAt = @now, 
    LastUpdated = @now 
WHERE Symbol = @symbol;
```

### 5. SignalR 实时推送

```csharp
// CryptoSpot.Infrastructure/BgService/SignalRDataPushService.cs
public class SignalRDataPushService : IRealTimeDataPushService
{
    public async Task PushPriceDataAsync(string symbol, object priceData)
    {
        var groupName = $"price_{symbol}";
        await _hubContext.Clients.Group(groupName).SendAsync("PriceUpdate", priceData);
    }
}
```

**推送频道**：
- 频道名：`price_{symbol}`（如 `price_BTCUSDT`）
- 事件名：`PriceUpdate`
- 推送频率：约 1 秒/次
- 数据格式：JSON 对象

#### 推送数据示例

```json
{
  "symbol": "BTCUSDT",
  "price": 50000.00,
  "change24h": 0.0523,      // 5.23% 涨幅
  "volume24h": 1234567.89,   // 24h 交易量（BTC）
  "high24h": 51000.00,       // 24h 最高价
  "low24h": 48500.00,        // 24h 最低价
  "timestamp": 1729584000000 // 时间戳
}
```

## 前端实现

### 1. SignalR 客户端订阅

```typescript
// frontend/src/services/signalRClient.ts
class SignalRClient {
  async subscribePriceData(
    symbols: string[],
    onUpdate: (data: any) => void,
    onError?: (error: any) => void
  ) {
    for (const symbol of symbols) {
      const groupName = `price_${symbol}`;
      await this.connection.invoke('JoinGroup', groupName);
    }
    
    this.connection.on('PriceUpdate', onUpdate);
    
    return () => {
      this.connection.off('PriceUpdate', onUpdate);
    };
  }
}
```

### 2. React Hook 封装

```typescript
// frontend/src/hooks/useMergedTickerData.ts
export interface MergedTickerData {
  symbol: string;
  lastPrice?: number;      // 最新价格
  change24h?: number;      // 24h 涨跌幅（小数，0.0523 = 5.23%）
  volume24h?: number;      // 24h 交易量
  high24h?: number;        // 24h 最高价
  low24h?: number;         // 24h 最低价
  timestamp: number;       // 更新时间戳
}

export function useMergedTickerData(symbol: string) {
  const [data, setData] = useState<MergedTickerData | null>(null);
  
  useEffect(() => {
    // 1. 从 localStorage 恢复缓存
    const cached = loadFromCache(symbol);
    if (cached) setData(cached);
    
    // 2. 订阅实时更新
    const unsubscribe = signalRClient.subscribePriceData(
      [symbol],
      (frame) => {
        const merged: MergedTickerData = {
          symbol: frame.symbol,
          lastPrice: frame.price,
          change24h: frame.change24h,
          volume24h: frame.volume24h,
          high24h: frame.high24h,
          low24h: frame.low24h,
          timestamp: frame.timestamp
        };
        
        setData(merged);
        saveToCache(symbol, merged);
      }
    );
    
    return () => unsubscribe();
  }, [symbol]);
  
  return { data, loading, error };
}
```

**关键特性**：
- 缓存恢复：页面刷新后立即显示缓存数据
- 实时更新：WebSocket 推送自动更新
- 数据合并：整合多个数据源（PriceUpdate + LastTradeAndMid）
- 本地存储：持久化到 localStorage

### 3. UI 组件使用

```typescript
// 示例：交易对信息展示
function TradingPairInfo({ symbol }: { symbol: string }) {
  const { data } = useMergedTickerData(symbol);
  
  if (!data) return <div>加载中...</div>;
  
  const changePercent = (data.change24h || 0) * 100;
  const isPositive = changePercent >= 0;
  
  return (
    <div>
      <h3>{symbol}</h3>
      <div className="price">${data.lastPrice?.toFixed(2)}</div>
      <div className={isPositive ? 'positive' : 'negative'}>
        {isPositive ? '+' : ''}{changePercent.toFixed(2)}%
      </div>
      <div className="stats">
        <span>24h 最高: ${data.high24h?.toFixed(2)}</span>
        <span>24h 最低: ${data.low24h?.toFixed(2)}</span>
        <span>24h 量: {data.volume24h?.toFixed(4)}</span>
      </div>
    </div>
  );
}
```

## 数据更新时序图

```
时间轴：     0ms          100ms        1000ms       1100ms
            │            │            │            │
OKX API     │───Ticker1──│            │───Ticker2──│
            │            │            │            │
Provider    │            │─OnTicker─→ │            │─OnTicker─→
            │            │            │            │
Relay       │            │──去重/限流─→│            │──去重/限流─→
Service     │            │            │            │            │
            │            ├─推送SignalR─┤            ├─推送SignalR─┤
            │            │            │            │            │
            │            └─持久化DB───→│            └─持久化DB───→│
            │                         │                         │
SignalR     │                         │─PriceUpdate→前端        │─PriceUpdate→前端
            │                         │                         │
前端        │───缓存恢复──│────更新UI──│────────────────────────│────更新UI──
```

## 数据库表结构

```sql
CREATE TABLE TradingPairs (
    Id INT PRIMARY KEY AUTO_INCREMENT,
    Symbol VARCHAR(20) NOT NULL,
    BaseAsset VARCHAR(10) NOT NULL,
    QuoteAsset VARCHAR(10) NOT NULL,
    Price DECIMAL(18,8) NOT NULL DEFAULT 0,
    Change24h DECIMAL(18,8) NOT NULL DEFAULT 0,      -- 24h 涨跌幅（小数）
    Volume24h DECIMAL(18,8) NOT NULL DEFAULT 0,      -- 24h 交易量
    High24h DECIMAL(18,8) NOT NULL DEFAULT 0,        -- 24h 最高价
    Low24h DECIMAL(18,8) NOT NULL DEFAULT 0,         -- 24h 最低价
    LastUpdated BIGINT NOT NULL DEFAULT 0,           -- 最后更新时间戳
    IsActive BOOLEAN NOT NULL DEFAULT 1,
    -- ... 其他字段
    UNIQUE INDEX idx_symbol (Symbol)
);
```

## API 接口

### REST API

#### 获取交易对信息（包含24h数据）

```http
GET /api/trading/pairs/{symbol}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "symbol": "BTCUSDT",
    "price": 50000.00,
    "change24h": 2500.00,
    "change24hPercent": 0.0526,
    "volume24h": 1234567.89,
    "high24h": 51000.00,
    "low24h": 48500.00,
    "lastUpdated": "2025-10-22T10:30:00Z"
  }
}
```

#### 获取所有交易对摘要

```http
GET /api/trading/pairs/summary
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "symbol": "BTCUSDT",
      "price": 50000.00,
      "change24hPercent": 0.0526,
      "isActive": true
    },
    {
      "symbol": "ETHUSDT",
      "price": 3000.00,
      "change24hPercent": 0.0312,
      "isActive": true
    }
  ]
}
```

### WebSocket 订阅

#### 订阅价格更新（包含24h数据）

```typescript
// 加入组
await connection.invoke('JoinGroup', 'price_BTCUSDT');

// 监听更新
connection.on('PriceUpdate', (data) => {
  console.log('Price:', data.price);
  console.log('24h Change:', data.change24h);
  console.log('24h Volume:', data.volume24h);
  console.log('24h High:', data.high24h);
  console.log('24h Low:', data.low24h);
});
```

## 配置说明

### appsettings.json

```json
{
  "MarketDataStream": {
    "Provider": "OKX",
    "Symbols": ["BTCUSDT", "ETHUSDT", "SOLUSDT"],
    "TickerUpdateInterval": 1000,  // 推送间隔（毫秒）
    "EnablePersistence": true       // 是否持久化到数据库
  }
}
```

### Program.cs 注册

```csharp
// 注册市场数据流提供者
builder.Services.AddSingleton<IMarketDataStreamProvider, OkxMarketDataStreamProvider>();

// 注册中继服务（后台服务）
builder.Services.AddHostedService<MarketDataStreamRelayService>();

// 注册 SignalR 推送服务
builder.Services.AddScoped<IRealTimeDataPushService, SignalRDataPushService>();
```

## 性能优化

### 1. 去重机制

```csharp
// 使用哈希值去重，避免重复推送相同数据
var hash = string.Concat(t.Last,'|',t.ChangePercent,'|',t.Volume24h);
if (state.Hash == hash) return; // 数据未变化，跳过推送
```

### 2. 限流机制

```csharp
// 最小推送间隔 1000ms
const int TickerMinPushIntervalMs = 1000;
if ((nowMs - state.LastPushMs) < TickerMinPushIntervalMs) return;
```

### 3. 异步持久化

```csharp
// 使用 Task.Run 异步持久化，不阻塞实时推送
_ = Task.Run(async () => {
    await priceService.UpdateTradingPairPriceAsync(...);
}, CancellationToken.None);
```

### 4. 缓存策略

```typescript
// 前端使用 localStorage 缓存
localStorage.setItem(`merged_ticker_cache_${symbol}`, JSON.stringify(data));

// 页面刷新时立即恢复
const cached = JSON.parse(localStorage.getItem(`merged_ticker_cache_${symbol}`));
```

## 监控和日志

### 后端日志

```csharp
_logger.LogDebug("Ticker Relay 推送完成 {Symbol} price={Price} change={Change}", 
    t.Symbol, t.Last, t.ChangePercent);

_logger.LogInformation("已持久化价格数据 {Symbol}: {Price}", symbol, price);

_logger.LogError(ex, "RelayTicker 失败 {Symbol}", t.Symbol);
```

### 前端调试

```typescript
// 查看原始数据帧
console.log('Raw Price Frame:', data._rawPrice);
console.log('Raw Ticker Frame:', data._rawTicker);

// 检查更新频率
console.log('Update Interval:', Date.now() - data.timestamp, 'ms');
```

## 故障排查

### 问题 1：24小时数据为空或为 0

**可能原因**：
1. OKX WebSocket 未连接
2. 数据提供者未订阅 Ticker
3. 数据库中无初始数据

**解决方案**：
```bash
# 检查后台服务日志
grep "Ticker Relay" logs/app.log

# 检查数据库
SELECT Symbol, Change24h, Volume24h, High24h, Low24h 
FROM TradingPairs 
WHERE Symbol = 'BTCUSDT';

# 手动更新测试
UPDATE TradingPairs 
SET Change24h = 0.05, Volume24h = 1000, High24h = 51000, Low24h = 49000 
WHERE Symbol = 'BTCUSDT';
```

### 问题 2：前端显示数据延迟

**可能原因**：
1. SignalR 连接断开
2. 前端未正确订阅
3. 数据缓存过期

**解决方案**：
```typescript
// 检查连接状态
console.log('Connected:', signalRClient.isConnected());

// 手动重连
await signalRClient.reconnect();

// 清除缓存
localStorage.removeItem(`merged_ticker_cache_${symbol}`);
```

### 问题 3：数据更新频率过高或过低

**调整配置**：
```csharp
// MarketDataStreamRelayService.cs
const int TickerMinPushIntervalMs = 2000; // 增加到 2 秒

// 或减少到 500ms 以获得更快更新
const int TickerMinPushIntervalMs = 500;
```

## 总结

### 数据流总结

1. **数据来源**：OKX WebSocket Ticker API（实时）
2. **中继处理**：MarketDataStreamRelayService（去重、限流、持久化）
3. **实时推送**：SignalR（WebSocket，约1秒/次）
4. **前端展示**：useMergedTickerData Hook（缓存、合并、更新）

### 关键文件

**后端**：
- `OkxMarketDataStreamProvider.cs` - 数据源
- `MarketDataStreamRelayService.cs` - 数据中继
- `SignalRDataPushService.cs` - 实时推送
- `PriceDataService.cs` - 数据持久化

**前端**：
- `signalRClient.ts` - WebSocket 客户端
- `useMergedTickerData.ts` - React Hook
- `types/index.ts` - TypeScript 类型定义

### 数据更新频率

- 外部 API：约 100ms - 1s
- 后端推送：最快 1s/次（限流）
- 前端更新：实时响应（WebSocket）
- 数据库持久化：异步，不阻塞

### 最佳实践

1. 使用缓存减少重复计算
2. 异步持久化不阻塞实时推送
3. 前端使用 localStorage 提升用户体验
4. 完善的错误处理和日志记录
5. 合理的限流和去重机制
